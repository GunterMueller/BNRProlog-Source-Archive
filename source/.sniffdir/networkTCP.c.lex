
netRead"6151 N {ihssize_t3=ijbytesRead45;igsize_t54ijtotalRead5;=65CN;AG{ijbytesRead79=83CN;AG{igbuffer8?BD96ijbytesRead99;iglength:4BE:;ijbytesRead:>;ijbytesRead;>=<8ieread<:(<>igsocket<?,=5igbuffer=7,==iglength=?);DB(?0ijbytesRead?1>?;CN)ijtotalReadA@BBDA@LijbytesReadA@O;}AAKAP(ABCijbytesReadABDBNABNiglengthACABLACHijbytesReadACK>ADECN);}ADOAP(AEG(AEHijbytesReadAEIBMAFC-AFFCM)BLAFJ(AFMiferrnoAFNBMAGDifEINTRAGG));ALijbytesReadAI@BMAIJ-AIMCM?-AJBCM:ijtotalReadAJG;}AKB
netWrite"6764 N {ihssize_t3>ihwritten46;igsize_t53igresult5:=61CN;AG{ihwritten75=7=CN;AG{igbuffer8=BD94ihwritten97;iglength:0BE:7ihwritten::;igresult;3BD;:ihwritten;=;ihwritten<;==3ifwrite=5(=:igsocket=;,>1igbuffer>3,>9iglength>;);}?5AP(?=ihwritten?>BNA@FiglengthA@IBLAA@ihwrittenAAC>AAKCN);}ABEAP(ABM(ABNihwrittenABOicEQACG-ACJCM)BLACN(ADAiferrnoADBicEQADHifEINTRADK));ALihwrittenAEOBMAFG-AFJCM?-AFOCM:igresultAGD;}AGL
BNRP_opensocketTCP"7161 N {EAilport_number96;nicon:8=:;CM,:>icid;0=;3iggetpid;5(;;);nijso_optval<4=<>CM,=1inreceiveSocket=3=>1CN;EIilsockaddr_in>>ilreceiveAddr?:;niglengthA@L=AACCG(AAKEIilsockaddr_inABC);DB(AE@idtcbAEApAEDihnumargsAEFicNEAENCM)AL(AFJifFALSEAFK);DB(AGG!AGHisBNRPnetworkUseableAGI){ihFD_ZEROAIB(AII&AIJihBNRPfdsAIK);ihFD_ZEROAJG(AJN&AJOiqBNRPconnectedFdsAK@);}ALDAM(ALNiicheckArgALO(AMGidtcbAMHpAMKieargsAMM[ANACM],AND&ANEilport_numberANF)){ACieINTTB@@:DB(BII(BIJilport_numberBIKicLTBJGioBNRPlowestPortBJJ)BKBKJ(BKMilport_numberBKNicGTBLJijUSHRT_MAXBLM))AL(BMNifFALSEBMO);DB(BOA(BOBinreceiveSocketBOC=C@AigsocketC@C(C@IihPF_INETC@J,CAAilSOCK_STREAMCAB,CAMCN))icEQCBB-CBECM){igperrorCFF(CFLs);AL(CK@ifFALSECKA);}CLADB(CNCiksetsockoptCND(CNNinreceiveSocketCNO,COLikSOL_SOCKETCON,D@HimSO_REUSEADDRD@J,DAF(DAHihoptValTDAI*DBA)&DBCijso_optvalDBD,DBMCG(DCEijso_optvalDCF))icNEDDBCN){igperrorDEM(DFCs);ifcloseDHA(DHFinreceiveSocketDHG);AL(DIOifFALSEDJ@);}DJIilreceiveAddrDKE.iksin_familyDLA=DLLihAF_INETDLN;ilreceiveAddrDMO.iisin_addrDNK.igs_addrDOD=DOKifhtonlDOM(E@BikINADDR_ANYE@C);ilreceiveAddrEAH.iisin_portEBD=EBMifhtonsEBO(ECDilport_numberECE);DB(EGEiebindEGF(EGJinreceiveSocketEGK,EHH(EHIEIiisockaddrEIA*EIJ)&EILilreceiveAddrEIM,EJHCG(EJOEIilsockaddr_inEKG))icEQELE-ELHCM){igperrorF@F(F@Ls);ifcloseFDH(FDMinreceiveSocketFDN);AL(FG@ifFALSEFGA);}FHAAB;ACieVARTFJD:DB(FKD(FKEinreceiveSocketFKF=FLDigsocketFLF(FLLihPF_INETFLM,FMDilSOCK_STREAMFME,FN@CN))icEQFNE-FNHCM){igperrorGAB(GAHs);AL(GELifFALSEGEM);}GFMilreceiveAddrGGH.iksin_familyGHD=GHOihAF_INETGIA;ilreceiveAddrGJB.iisin_addrGJN.igs_addrGKG=GKNifhtonlGL@(GLEikINADDR_ANYGLF);ilreceiveAddrGMD.iisin_portGN@=GNIifhtonsGNK(GO@CN);DB(HAJiebindHAK(HAOinreceiveSocketHB@,HBM(HBNEIiisockaddrHCF*HCO)&HDAilreceiveAddrHDB,HDMCG(HEDEIilsockaddr_inHEL))icEQHFJ-HFMCM){igperrorIAM(IBCs);ifcloseIEE(IEJinreceiveSocketIEK);AL(IHAifFALSEIHB);}IHKDB(IIHilgetsocknameIII(IJDinreceiveSocketIJE,IKB(IKDEIiisockaddrIKL*ILE)&ILGilreceiveAddrILH,IMC(IMEiloptValSizeTIMF*INB)&INDiglengthINE)icNEINMCN){igperrorJAB(JAHs);ifcloseJED(JEIinreceiveSocketJEJ);AL(JGEifFALSEJGF);}JGOAB;AE:AL(JKLifFALSEJKM);}JLF{EAigbufsizJNL;nigoptlenJOH=JOOCG(K@GigbufsizK@H);DB(KBNikgetsockoptKBO(KCIinreceiveSocketKCJ,KDGikSOL_SOCKETKDI,KECijSO_RCVBUFKEE,KEN(KF@ihoptValTKFA*KFI)&KFKigbufsizKFL,KGB&KGDigoptlenKGE)icEQKGMCN)ihfprintfKHO(KIFigstderrKIG,KIMs,KL@inreceiveSocketKLB,KLOigbufsizKMA);DCihfprintfKOC(KOJigstderrKOK,L@As,LAMinreceiveSocketLAO);}LCCijso_optvalLCN=LDHCM;DB(LE@iksetsockoptLEA(LEKinreceiveSocketLEL,LFIilIPPROTO_TCPLFK,LGFilTCP_NODELAYLGH,LHC(LHEihoptValTLHF*LHN)&LI@ijso_optvalLIA,LIJCG(LJBijso_optvalLJC))icNELJOCN){igperrorLLJ(LM@s);ifcloseLNN(LOCinreceiveSocketLOD);AL(M@LifFALSEM@M);}MAFisBNRPnetworkUseableMAJ=MBMieTRUEMBO;ilBNRPfdCountMCFCEMDB;igFD_SETMDH(MDNinreceiveSocketMDO,MEL&MEMihBNRPfdsMEN);{igprintfMHB(MHHs,MJKinreceiveSocketMJL);igprintfMKM(MLCs,MNJ(MNKEA)ifntohsMOA(MOFilreceiveAddrMOG.iisin_portN@C));}NAEAL(NBEifunifyNBF(NBKidtcbNBL,NBOidtcbNC@pNCCieargsNCE[NCICM],NCLihmakeintNCM(NDD&NDEidtcbNDFpNDIichpNDK,NDM(NDNEA)ifntohsNED(NEIilreceiveAddrNEJ.iisin_portNFF)))BLNGMifunifyNH@(NHEidtcbNHF,NHIidtcbNHJpNHMieargsNHO[NICCM],NIFihmakeintNIG(NIN&NIOidtcbNJ@pNJCichpNJE,NJGinreceiveSocketNJH)));}NKJ
BNRP_listenSocket"10948 N {EAigsocket24;DB(30idtcb31p34ihnumargs36icNE3>CM)AL(4:ifFALSE4;);DB(58iicheckArg59(61idtcb62p65ieargs67[6;CM],6>&6?igsocket70)icNE78ieINTT7;)AL(87ifFALSE88);DB(95igsocket96icLT9=CM)AL(:9ifFALSE::);DB(;7!;8iiFD_ISSET;9(<1igsocket<2,<8&<9ihBNRPfds<:))AL(=:ifFALSE=;);iferrno>6=><CN;iglisten?2(?8igsocket?9,@OOijSOMAXCONNA@@);AL(AACifunifyAAD(AAIidtcbAAJ,AAMidtcbAANpABAieargsABC[ABGCM],ABJihmakeintABK(ACB&ACCidtcbACDpACGichpACI,ACKiferrnoACL)));}ADF
BNRP_acceptCon"11291 N {EAigsocket21;EIilsockaddr_in31ijsock_addr3=;nikrcv_socket4=,57iesize59=5>CG(66ijsock_addr67);DB(78idtcb79p7<ihnumargs7>icNE86CM)AL(92ifFALSE93);DB(:0iicheckArg:1(:9idtcb::p:=ieargs:?[;3CM],;6&;7igsocket;8)icNE<0ieINTT<3)AL(<?ifFALSE=0);DB(=;igsocket=<icLT>3CM)AL(>?ifFALSE?0);DB(?;!?<iiFD_ISSET?=(A@EigsocketA@F,A@L&A@MihBNRPfdsA@N))AL(AB@ifunifyABA(ABFidtcbABG,ABJidtcbABKpABNieargsAC@[ACDCM],ACGihmakeintACH(ACO&AD@idtcbADApADDichpADF,ADHiiENOTSOCKADI)));DB(AEIiiFD_ISSETAEJ(AFBigsocketAFC,AFI&AFJiqBNRPconnectedFdsAFK))AL(AHGifunifyAHH(AHMidtcbAHN,AIAidtcbAIBpAIEieargsAIG[AIKCM],AINihmakeintAIO(AJF&AJGidtcbAJHpAJKichpAJM,AJOihEISCONNAK@)));iferrnoAKN=ALDCN;igprintfAMK(ANAs);DB(BAMimselectSocketBAN(BBJigsocketBBK,BCAirBNRPconnect_timerBCB)){igprintfBEK(BFAs);DB(BIM(BINikrcv_socketBIO=BJJigacceptBJL(BKBigsocketBKC,BKI(BKJEIiisockaddrBLB*BLK)&BLMijsock_addrBLN,BMG(BMHiloptValSizeTBMI*BNE)&BNGiesizeBNH))icEQBNO-BOBCM){igperrorC@M(CACs);AL(CCFifunifyCCG(CCLidtcbCCM,CD@idtcbCDApCDDieargsCDF[CDJCM],CDMihmakeintCDN(CEE&CEFidtcbCEGpCEJichpCEL,CENiferrnoCEO)));}CFKigFD_SETCFO(CGEikrcv_socketCGF,CH@&CHAiqBNRPconnectedFdsCHB);igFD_SETCIG(CIMikrcv_socketCIN,CJH&CJIihBNRPfdsCJJ);ilBNRPfdCountCKFCECLA;igprintfCMG(CMMs);}D@NDC{igprintfDBK(DCAs);AL(DFKifunifyDFL(DGAidtcbDGB,DGEidtcbDGFpDGIieargsDGK[DGOCM],DHBihmakeintDHC(DHJ&DHKidtcbDHLpDHOichpDIA,DICijETIMEDOUTDID)));}DJC{EAigbufsizDLI;nigoptlenDME=DMLCG(DNDigbufsizDNE);DB(DOIikgetsockoptDOJ(E@Dikrcv_socketE@E,E@OikSOL_SOCKETEAA,EAKijSO_RCVBUFEAM,EBF(EBHihoptValTEBI*ECA)&ECCigbufsizECD,ECJ&ECLigoptlenECM)icEQEDECN)ihfprintfEEG(EENigstderrEEO,EFEs,EHHikrcv_socketEHJ,EIDigbufsizEIF);DCihfprintfEKH(EKOigstderrEL@,ELFs,ENBikrcv_socketEND);}EOEAL(F@FifunifyF@G(F@LidtcbF@M,FA@idtcbFAApFADieargsFAF[FAJCM],FAMiuBNRPLookupTempSymbolFAN(FCBidtcbFCC,FCFijinet_ntoaFCG(FD@ijsock_addrFDA.iisin_addrFDK)))BLFEIifunifyFEL(FFAidtcbFFB,FFEidtcbFFFpFFIieargsFFK[FFOCM],FGBihmakeintFGC(FGJ&FGKidtcbFGLpFGOichpFHA,FHCijsock_addrFHD.iisin_portFHN))BLFIKifunifyFIN(FJCidtcbFJD,FJGidtcbFJHpFJKieargsFJM[FKACM],FKDihmakeintFKE(FKL&FKMidtcbFKNpFLAichpFLC,FLEikrcv_socketFLF))BLFMEifunifyFMH(FMMidtcbFMN,FNAidtcbFNBpFNEieargsFNG[FNKCM],FNNihmakeintFNO(FOF&FOGidtcbFOHpFOKichpFOM,FOOCN)));}G@F
BNRP_receivemessageTCP"13106 N {EAigsocket4=;c*5>igbuffer60;c*71ilsmallbuffer73;EAikbuffersize8;;nigoptlen:2;EAiireadsize;5=;?CN;EAigfilefd<?;nijerrorcode>2=><CN;nigretval?<=A@FieTRUEA@H;nihcurrentAAI,AB@imcurrentStartABB;igsize_tACDifbytesACK;EAigresultADK;DB(AEHidtcbAEIpAELihnumargsAENicNEAFFCM)AL(AGBifFALSEAGC);DB(AGN!AGOisBNRPnetworkUseableAH@)AL(AIJifFALSEAIK);DB(AJFiicheckArgAJG(AJOidtcbAK@pAKCieargsAKE[AKICM],AKL&AKMigsocketAKN)icNEALFieINTTALI)AL(AMEifFALSEAMF);DB(ANAigsocketANBicLTANICM)AL(AOEifFALSEAOF);DB(B@C!B@DiiFD_ISSETB@E(B@MigsocketB@N,BAD&BAEihBNRPfdsBAF))AL(BE@ifunifyBEA(BEFidtcbBEG,BEJidtcbBEKpBENieargsBF@[BFDCM],BFGihmakeintBFH(BFO&BG@idtcbBGApBGDichpBGF,BGHiiENOTSOCKBGI)));DB(BHK!BHLiiFD_ISSETBHM(BIEigsocketBIF,BIL&BIMiqBNRPconnectedFdsBIN))AL(BMHifunifyBMI(BMNidtcbBMO,BNBidtcbBNCpBNFieargsBNH[BNLCM],BNOihmakeintBO@(BOG&BOHidtcbBOIpBOLichpBON,C@@iiENOTCONNC@A)));igprintfCB@(CBFs);igoptlenCIO=CJFCG(CJNikbuffersizeCJO);DB(CLCikgetsockoptCLD(CLNigsocketCLO,CMEikSOL_SOCKETCMG,CNAijSO_RCVBUFCNC,CNL(CNNihoptValTCNO*COG)&COIikbuffersizeCOJ,D@D(D@FiloptValSizeTD@G*DAC)&DAEigoptlenDAF)icNEDANCN)ikbuffersizeDBL=DCGimMAX_MSG_SIZEDCI;DB(DGGikbuffersizeDGHicLEDHCCN)ikbuffersizeDLF=DMAimMAX_MSG_SIZEDMC;igprintfDOF(DOLs,EBFikbuffersizeEBH);igbufferED@=EDG(EDIc*EDO)ilBNRP_mallocEEA(EELikbuffersizeEEM+EFGCM);ilsmallbufferEG@=EGL(EGNc*EHD)ilBNRP_mallocEHF(EIAikbuffersizeEIB+EILCM);DB(EJHigbufferEJIicEQEK@CNBKEKEilsmallbufferEKHicEQELDCN)ALifunifyEMI(EMNidtcbEMO,ENBidtcbENDpENGieargsENI[ENMCM],EO@ihmakeintEOB(EOI&EOJidtcbEOKpEONichpF@@,F@BigENOMEMF@D));DB(FDEimselectSocketFDF(FEBigsocketFEC,FEIioBNRPread_timerFEJ)){igprintfFH@(FHFs);AG{iferrnoFMK=FNACN;iireadsizeFOB=FOKiereadFOM(G@AigsocketG@B,G@HigbufferG@J,GA@ikbuffersizeGAB);}GBGAP(GBO(GC@iireadsizeGCAicEQGCJ-GCMCM)BLGDA(GDDiferrnoGDEicEQGDKifEINTRGDN));DB(GELiireadsizeGEMicEQGFF-GFICM){igperrorGJO(GKEs);ijerrorcodeGNC=GNMiferrnoGNO;}GOHDB(GOOiireadsizeH@@icEQH@ICN){igprintfHEB(HEHs);ijerrorcodeHHN=HIHiiENOTCONNHIJ;}HJF}HJLDC{igprintfHLG(HLMs);ijerrorcodeI@K=IAEijETIMEDOUTIAG;}IDMigprintfIFD(IFJs,IIAiireadsizeIIC);DB(IJM!IJNijerrorcodeIJO){DB(IOIiicheckArgIOJ(J@BidtcbJ@CpJ@FieargsJ@H[J@LCM],J@O&JA@igfilefdJAA)icEQJAIieINTTJAL){AG{iferrnoJIA=JIGCN;ifbytesJJL=JKBigfwriteJKD(JKJigbufferJKK,JLACG(JLIc),JLOiireadsizeJMA,JMI(JMKieFILEJML*JNA)igfilefdJNC);}JOHAP(K@@(K@AifbytesK@BicEQK@H-K@KCM)BLK@O(KABiferrnoKACicEQKAIifEINTRKAL));igfflushKCA(KCG(KCHieFILEKCI*KCN)igfilefdKD@);igprintfKFE(KFKs,KHFifbytesKHG,KHLiireadsizeKHM);DB(KJNifbytesKJOicLEKKECN)ijerrorcodeKLK=KMEiferrnoKMG;DB(KNM!KNNijerrorcodeKNOBLKOIigferrorKOL(L@B(L@CieFILEL@D*L@I)igfilefdL@K))ijerrorcodeLBD=LBNidEIOLC@;}LCMDC{ijBNRP_termMGLihsymTermMHF;ijheapcheckMIK(MJDiireadsizeMJE+MJMCM);igresultMMG=MMNiimaketermMN@(MNHihLISTTAGMNI,MO@idtcbMOBpMOEichpMOG);igbufferN@M[NACiireadsizeNAD]=NANDA;ihcurrentND@=NDHCN;imcurrentStartNID=NJACN;AP(OAJihcurrentOAKicLEOBCiireadsizeOBF){ilsmallbufferOHD[OHOihcurrentOI@-OIHimcurrentStartOIJ]=OJHigbufferOJJ[OK@ihcurrentOKA];DB(OMAigbufferOMC[OMIihcurrentOMJ]BMONCDA){DB(QPUSihcurrentQPUUBNQPU]CNBLQPVRigbufferQPVU[QPV[ihcurrentQPV\-QPWSCM]BNQPWWDA){ihsymTermQPX[=QPYSiuBNRPLookupTempSymbolQPYU(QPZYidtcbQPZZ,QPZ]ilsmallbufferQPZ^);iepushQP\T(QP\XijBNRP_termQP\Y,QP]RidtcbQP]TpQP]WichpQP]Y,QP][ihsymTermQP]]);}QP^[imcurrentStartQQRP=QQR]ihcurrentQQR_+QQSWCM;}QQS^ihcurrentQQTRCEQQTY;}QQV_iepushQQW^(QQXREA,QQXWidtcbQQXXpQQX[ichpQQX],QQX_CN);igretvalQQZT=QQZ[ifunifyQQZ](QQ[RidtcbQQ[S,QQ[VidtcbQQ[XpQQ[[ieargsQQ[][QQ\QCM],QQ\TigresultQQ\V);}QQ]W}QQ^YijBNRP_freeQQ_T(QQ_]igbufferQQ_^);ijBNRP_freeQRP[(QRQTilsmallbufferQRQU);ALigretvalQRR^BLQRSUifunifyQRSX(QRS]idtcbQRS^,QRTQidtcbQRTSpQRTVieargsQRTX[QRT\CM],QRT_ihmakeintQRUQ(QRUX&QRUYidtcbQRUZpQRU]ichpQRU_,QRVQijerrorcodeQRVS));}QRWP
BNRP_makeCon"17843 N {EAigsocket1?,25ihip_term27,2>icip30,32ieport34;EIilsockaddr_in42ildestination4>;niderr64;ninerrno_connect72;nijerrorcode8:=94CN;DB(9=idtcb9>p:1ihnumargs:3icNE:;CM)AL(;7ifFALSE;8);DB(<3!<4isBNRPnetworkUseable<5)AL(=?ifFALSE>0);DB(><iicheckArg>=(?5idtcb?6p?9ieargs?;[@OOCM],A@B&A@CigsocketA@D)icNEA@LieINTTA@O)AL(AAKifFALSEAAL);DB(ABGiicheckArgABH(AC@idtcbACApACDieargsACF[ACJCM],ACM&ACNihip_termACO)icNEADHihSYMBOLTADK)AL(AEJifFALSEAEK);DB(AFFiicheckArgAFG(AFOidtcbAG@pAGCieargsAGE[AGICM],AGL&AGMieportAGN)icNEAHDieINTTAHG)AL(AICifFALSEAID);DB(AJ@!AJAiiFD_ISSETAJB(AJJigsocketAJK,AKA&AKBihBNRPfdsAKC))AL(ALEifunifyALF(ALKidtcbALL,ALOidtcbAM@pAMCieargsAME[AMICM],AMLihmakeintAMM(AND&ANEidtcbANFpANIichpANK,ANMiiENOTSOCKANN)));DB(AOO(B@@icipB@A=B@Dijinet_addrB@F(B@OignameofBA@(BAFihip_termBAG)))icEQBBBilINADDR_NONEBBE)AL(BCHifFALSEBCI);DB(BDEiiFD_ISSETBDF(BDNigsocketBDO,BEE&BEFiqBNRPconnectedFdsBEG))AL(BGBifunifyBGC(BGHidtcbBGI,BGLidtcbBGMpBH@ieargsBHB[BHFCM],BHIihmakeintBHJ(BIA&BIBidtcbBICpBIFichpBIH,BIJihEISCONNBIK)));ildestinationBJI.iksin_familyBKE=BL@ihAF_INETBLB;ildestinationBLL.iisin_portBMH=BNAifhtonsBNC(BNHieportBNI);igmemcpyBOA(BOG(BOHc*BON)&C@@ildestinationC@A.iisin_addrC@M,CAE(CAFc*CAL)&CANicipCAO,CBACG(CBHEA));igprintfCDG(CDMs);ioenableNONBLOCKCHC(CIAigsocketCIB);AG{iferrnoD@H=D@NCN;iderrDAK=DAOihconnectDBA(DBHigsocketDBI,DBO(DC@EIiisockaddrDCH*DDA)&DDCildestinationDDD,DDOCG(DEGildestinationDEH));}DFKAP(DGC(DGDiderrDGEicEQDGI-DGLCM)BLDH@(DHCiferrnoDHDicEQDHJifEINTRDHM));inerrno_connectDIJ=DJHiferrnoDJJ;ipdisableNONBLOCKDKE(DLDigsocketDLE);DB(E@HiderrE@IicEQE@M-EA@CM){DB(EBACNBKEDE(EDHinerrno_connectEDIicEQEEGilEINPROGRESSEEJ)BKEHN(EIAinerrno_connectEIBicEQEJ@ilEWOULDBLOCKEJC)BKEMB(EMEinerrno_connectEMFicEQENDigEAGAINENG)BKFAC(FAFinerrno_connectFAGicEQFBEiiEALREADYFBH)){igprintfFKA(FKGs);iferrnoGHG=GHMCN;iderrGIN=GJBiuselectSocketForWriteGJD(GKHigsocketGKI,GKOirBNRPconnect_timerGLA);DB(GNDiderrGNEicEQGNI-GNLCM){igperrorHAB(HAHs);ijerrorcodeHEM=HFGiferrnoHFI;}HGLDCDB(HIBiderrHIC){AG{iferrnoIDM=IECCN;iderrIFL=IG@ihconnectIGB(IGIigsocketIGJ,IH@(IHAEIiisockaddrIHI*IIB)&IIDildestinationIIE,IJ@CG(IJGildestinationIJH));}ILGAP(ILO(IM@iderrIMAicEQIME-IMHCM)BLIML(IMOiferrnoIN@icEQINFifEINTRINI));DB(J@FiderrJ@GicEQJ@K-J@NCM){AM(JBOiferrnoJC@){ACihEISCONNJEB:ijerrorcodeJEK=JFECN;AB;ACijETIMEDOUTJJE:ACigEINVALJLI:ijerrorcodeJMB=JMLimECONNREFUSEDJMN;AB;AE:ijerrorcodeKBE=KBOiferrnoKCA;igperrorKF@(KFFs);}KJK}KKMDCijerrorcodeKNI=KOCCN;}LCGDCijerrorcodeLEJ=LFDijETIMEDOUTLFF;}LJHDC{AM(LLLinerrno_connectLLM){ACihEISCONNLNO:ijerrorcodeLOH=M@BCN;AB;ACijETIMEDOUTMCJ:ACigEINVALMEF:ijerrorcodeMEO=MFIimECONNREFUSEDMFK;AB;AE:ijerrorcodeMJJ=MKDiferrnoMKF;igperrorMMM(MNCs);}NB@}NBJ}NC@DB(NCJ!NCKijerrorcodeNCM){igprintfNFB(NFHs);igFD_SETNIH(NINigsocketNIO,NJE&NJFiqBNRPconnectedFdsNJG);}NKNALifunifyNLI(NLNidtcbNLO,NMBidtcbNMCpNMFieargsNMH[NMLCM],NMOihmakeintNN@(NNG&NNHidtcbNNIpNNLichpNNN,NO@ijerrorcodeNOB));}NOO
BNRP_sendmessageTCP"21689 N {EAigsocket29,2?ihmessage31;ieFILE3>*45iffilep46;EIilsockaddr_in56ildestination62;ipBNRP_sighandler73iroldSigPipeHandler83;c*:1igbuffer:2;EAikbuffersize>9;nijreadbytesAC@;nikwritebytesAGG;nijerrorcodeAKN;nigoptlenB@E;EAijtotalsizeBBI=BCCCN;EAiktotalbytesBDD=BDNCN;DB(BENidtcbBEOpBFBihnumargsBFDicNEBFLCM)AL(BGHifFALSEBGI);DB(BHD!BHEisBNRPnetworkUseableBHF)AL(BJ@ifFALSEBJA);DB(BJOiicheckArgBK@(BKHidtcbBKIpBKLieargsBKN[BLBCM],BLE&BLFigsocketBLG)icNEBLOieINTTBMB)AL(BMNifFALSEBMO);DB(BNJ!BNKiiFD_ISSETBNL(BODigsocketBOE,BOK&BOLihBNRPfdsBOM))AL(CCCifunifyCCD(CCIidtcbCCJ,CCMidtcbCCNpCDAieargsCDC[CDGCM],CDJihmakeintCDK(CEB&CECidtcbCEDpCEGichpCEI,CEKiiENOTSOCKCEL)));DB(CFO!CG@iiFD_ISSETCGA(CGIigsocketCGJ,CH@&CHAiqBNRPconnectedFdsCHB))AL(CKHifunifyCKI(CKNidtcbCKO,CLBidtcbCLCpCLFieargsCLH[CLLCM],CLOihmakeintCM@(CMG&CMHidtcbCMIpCMLichpCMN,CN@iiENOTCONNCNA)));ijerrorcodeCOC=COMCN;iroldSigPipeHandlerD@G=DAIiwBNRP_installSighandlerDAK(DCAihSIGPIPEDCB,DCIitBNRP_initSighandlerDCK(DDNiosigPipeHandlerDDO));AM(DFMiicheckArgDFN(DGFidtcbDGGpDGJieargsDGL[DH@CM],DHC&DHDihmessageDHE)){ACihSYMBOLTDIJ:igprintfDOF(DOLs);iferrnoEDC=EDJCN;igbufferEEG=EENignameofEF@(EFFihmessageEFG);ikbuffersizeEGI=EHDigstrlenEHF(EHLigbufferEHM)+EIECM;AG{ikwritebytesELF=EMAifwriteEMC(EMHigsocketEMI,EMOigbufferENA,ENGikbuffersizeENI);}EONAP(F@F(F@GikwritebytesF@HicEQFAC-FAFCM)BLFAJ(FAMiferrnoFANicEQFBDifEINTRFBG));DB(FDCikwritebytesFDDicEQFDO-FEBCM){igperrorFJC(FJIs);ijerrorcodeFMD=FMNiferrnoFN@;AB;}G@BigprintfGAL(GBBs,GEOikwritebytesGG@,GGJikbuffersizeGGL);AB;ACieINTTGJI:igprintfGON(H@Ds);igoptlenHGB=HGICG(HHAikbuffersizeHHB);DB(HIJikgetsockoptHIK(HJEigsocketHJF,HJLikSOL_SOCKETHJN,HKHijSO_SNDBUFHKJ,HLC(HLEihoptValTHLF*HLN)&HM@ikbuffersizeHMA,HMK(HMMiloptValSizeTHMN*HNJ)&HNLigoptlenHNM)icNEHOECN)ikbuffersizeI@G=IABimMAX_MSG_SIZEIAD;DB(IELikbuffersizeIEMicLEIFHCN)ikbuffersizeIKA=IKLimMAX_MSG_SIZEIKN;igprintfINE(INKs,JABikbuffersizeJAD);igbufferJCI=JD@(JDBc*JDH)ilBNRP_mallocJDJ(JEEikbuffersizeJEF);DB(JI@igbufferJIAicEQJIHCN){ijerrorcodeJNE=JNOigENOMEMJOA;AB;}KADiffilepKAO=KBE(KBGieFILEKBH*KBM)ihmessageKBO;iiclearerrKFM(KGEiffilepKGF);AP(LBN!LBOiefeofLC@(LCDiffilepLCE)BLLCL!LCOigferrorLD@(LDFiffilepLDG)BLLDN!LEAijerrorcodeLEB){iferrnoLFM=LGCCN;AG{ijreadbytesLII=LJCiffreadLJE(LJJ(LJKEP*LKA)igbufferLKC,LKICG(LL@c),LLFikbuffersizeLLG,LMAiffilepLMC);}LNGAP(LNO(LO@ijreadbytesLOAicEQLOK-LONCM)BLM@B(M@EiferrnoM@FicEQM@LifEINTRM@O));DB(MBHijreadbytesMBIicGTMCCCN){igprintfMEK(MFAs,MHGijreadbytesMHI);iferrnoMJL=MKBCN;AG{ikwritebytesMN@=MNKifwriteMNM(MOBigsocketMOC,MOI(MOJc*N@@)igbufferN@B,N@HijreadbytesN@J);}NBFAP(NBN(NBOikwritebytesNC@icEQNCK-NCNCM)BLNDB(NDEiferrnoNDFicEQNDLifEINTRNDO));DB(NH@ikwritebytesNHAicNENHLijreadbytesNHO){igperrorNMC(NMIs);ijerrorcodeO@L=OAFiferrnoOAH;AB;}ODJijtotalsizeOFLBDOGGijreadbytesOGJ;iktotalbytesOIEBDOJ@ikwritebytesOJC;}OLB}OLFDB(OMI!OMJijerrorcodeOMKBLONEigferrorONH(ONNiffilepONO))ijerrorcodeQPPS=QPP]idEIOQPP_;ijBNRP_freeQPQ](QPRVigbufferQPRW);igprintfQPWX(QPW^s,QPYVigferrorQPYX(QPY^iffilepQPY_),QPZUiefeofQPZV(QPZZiffilepQPZ[));igprintfQP[\(QP\Rs,QP_^iktotalbytesQP__,QQPYijtotalsizeQQPZ);AB;AE:iwBNRP_installSighandlerQQTR(QQUXihSIGPIPEQQUY,QQVPiroldSigPipeHandlerQQVR);ALifFALSEQQXU;}QQYPiwBNRP_installSighandlerQQYZ(QQ[PihSIGPIPEQQ[Q,QQ[XiroldSigPipeHandlerQQ[Z);ALifunifyQQ]V(QQ][idtcbQQ]\,QQ]_idtcbQQ^PpQQ^SieargsQQ^U[QQ^YCM],QQ^\ihmakeintQQ^](QQ_T&QQ_UidtcbQQ_VpQQ_YichpQQ_[,QQ_]ijerrorcodeQQ__));}QRP\
BNRP_sendTCPterm"26452 N {EAigsocket29;ipBNRP_sighandler35iroldSigPipeHandler45;iiTSBuffer5<*65igbuffer66;EAikbuffersize::;nigoptlen?1;nijerrorcodeA@D;DB(AAFidtcbAAGpAAJihnumargsAALicNEABDCM)AL(AC@ifFALSEACA);DB(ACO!AD@isBNRPnetworkUseableADA)AL(AEKifFALSEAEL);DB(AIIiicheckArgAIJ(AJBidtcbAJCpAJFieargsAJH[AJLCM],AJO&AK@igsocketAKA)icNEAKIieINTTAKL)AL(ALHifFALSEALI);DB(AMG!AMHiiFD_ISSETAMI(ANAigsocketANB,ANH&ANIihBNRPfdsANJ))AL(BAOifunifyBB@(BBEidtcbBBF,BBIidtcbBBJpBBMieargsBBO[BCCCM],BCFihmakeintBCG(BCN&BCOidtcbBD@pBDCichpBDE,BDGiiENOTSOCKBDH)));DB(BEK!BELiiFD_ISSETBEM(BFEigsocketBFF,BFL&BFMiqBNRPconnectedFdsBFN))AL(BJCifunifyBJD(BJIidtcbBJJ,BJMidtcbBJNpBKAieargsBKC[BKGCM],BKJihmakeintBKK(BLB&BLCidtcbBLDpBLGichpBLI,BLKiiENOTCONNBLL)));igoptlenC@N=CAECG(CAMikbuffersizeCAN);DB(CCBikgetsockoptCCC(CCMigsocketCCN,CDDikSOL_SOCKETCDF,CE@ijSO_SNDBUFCEB,CEK(CEMihoptValTCEN*CFF)&CFHikbuffersizeCFI,CGC(CGEiloptValSizeTCGF*CHB)&CHDigoptlenCHE)icNECHMCN)ikbuffersizeCID=CIOimMAX_MSG_SIZECJA;DB(CNCikbuffersizeCNDicLECNOCN)ikbuffersizeCOF=D@AimMAX_MSG_SIZED@C;ikbuffersizeDAEBDDB@CM;igbufferDEE=DELiyBNRP_GetNetScratchBufferDEN(DGFikbuffersizeDGG+DHBCM);DB(DIAigbufferDIBBMDIICN)AL(DJFifunifyDJG(DJLidtcbDJM,DK@idtcbDKApDKDieargsDKF[DKJCM],DKMihmakeintDKN(DLE&DLFidtcbDLGpDLJichpDLL,DLNigENOMEMDLO)));DB(E@J!E@KirBNRP_termToStringE@L(EAM(EANiiBNRP_TCBEAO*EBG)idtcbEBJ,EBMidtcbEBOpECBieargsECD[ECHCM],ECKigbufferECMpEDCiedataEDE,EDIikbuffersizeEDK))AL(EEOifunifyEF@(EFEidtcbEFF,EFIidtcbEFJpEFMieargsEFO[EGCCM],EGFihmakeintEGG(EGN&EGOidtcbEH@pEHCichpEHE,EHG-EHICM)));iroldSigPipeHandlerEJA=EKCiwBNRP_installSighandlerEKE(ELKihSIGPIPEELL,EMCitBNRP_initSighandlerEME(ENHiosigPipeHandlerENI));igbufferFB@pFBFiidataSizeFBH=FCAigstrlenFCC(FCIigbufferFCJpFD@iedataFDB)+FDHCM+FDLCG(FEDiiTSHeaderFEE);inBuildTSHeaderFGK(FHHigbufferFHI);ijerrorcodeFIF=FJ@CN;DB(FJLiinetWriteFJM(FKEigsocketFKF,FKL(FKNEP*FLC)&FLF(FLGigbufferFLHpFLNigheaderFM@),FMGigbufferFMIpFMOiidataSizeFNA)BMFNK-FNNCM)ijerrorcodeFOC=FOMiferrnoFOO;iwBNRP_installSighandlerG@K(GBAihSIGPIPEGBB,GBIiroldSigPipeHandlerGBK);ALifunifyGDJ(GDOidtcbGE@,GECidtcbGEDpGEGieargsGEI[GEMCM],GF@ihmakeintGFA(GFH&GFIidtcbGFJpGFMichpGFO,GGAijerrorcodeGGC));}GH@
BNRP_receiveTCPterm"28524 N {EAigsocket2;;iiTSBuffer37*3?igbuffer41;ihssize_t4=iireadsize56=60CN;nijerrorcode70=7:CN;EAikbytesAvail8:;igsize_t<9ilbytesToRead=0;ijBNRP_term>1ieterm>;;DB(A@LidtcbA@MpAA@ihnumargsAABicNEAAJCM)AL(ABFifFALSEABG);DB(ACE!ACFisBNRPnetworkUseableACG)AL(AEAifFALSEAEB);DB(AGMiicheckArgAGN(AHFidtcbAHGpAHJieargsAHL[AI@CM],AIC&AIDigsocketAIE)icNEAIMieINTTAJ@)AL(AJLifFALSEAJM);DB(AKKigsocketAKLicLTALCCM)AL(ALOifFALSEAM@);DB(AMN!AMOiiFD_ISSETAN@(ANHigsocketANI,ANO&AO@ihBNRPfdsAOA))AL(BBJifunifyBBK(BC@idtcbBCA,BCDidtcbBCEpBCHieargsBCJ[BCNCM],BDAihmakeintBDB(BDI&BDJidtcbBDKpBDNichpBE@,BEBiiENOTSOCKBEC)));DB(BFF!BFGiiFD_ISSETBFH(BG@igsocketBGA,BGG&BGHiqBNRPconnectedFdsBGI))AL(BKBifunifyBKC(BKHidtcbBKI,BKLidtcbBKMpBL@ieargsBLB[BLFCM],BLIihmakeintBLJ(BMA&BMBidtcbBMCpBMFichpBMH,BMJiiENOTCONNBMK)));igbufferC@M=CADiuBNRP_GetSocketBufferCAF(CBJigsocketCBK);DB(CCKigbufferCCLBMCDCCN)AL(CE@ifunifyCEA(CEFidtcbCEG,CEJidtcbCEKpCENieargsCF@[CFDCM],CFGihmakeintCFH(CFO&CG@idtcbCGApCGDichpCGF,CGHigENOMEMCGJ)));iiwaitabitCJI:DB(CKIimselectSocketCKJ(CLFigsocketCLG,CLMioBNRPread_timerCLN)){DB(DAJifioctlDAK(DB@igsocketDBA,DBGiiFIONREADDBI,DCA&DCCikbytesAvailDCD)<DD@CN)AL(DE@ifunifyDEA(DEFidtcbDEG,DEJidtcbDEKpDENieargsDF@[DFDCM],DFGihmakeintDFH(DFO&DG@idtcbDGApDGDichpDGF,DGHiferrnoDGJ)));DB(DHNikbytesAvailDHOBMDIJCN)AL(DJKifunifyDJL(DKAidtcbDKB,DKEidtcbDKGpDKJieargsDKL[DL@CM],DLCihmakeintDLE(DLL&DLMidtcbDLNpDMAichpDMC,DMEiiENOTCONNDMG)));DB(E@BigbufferE@CpE@IiidataSizeE@K<EADCG(EALiiTSHeaderEAM)BLEBGikbytesAvailEBJBPECECN){ilbytesToReadEDB=EDNCG(EEFiiTSHeaderEEG)-EFAigbufferEFCpEFIiidataSizeEFK;DB(EGMilbytesToReadEGN>EHJikbytesAvailEHL)ilbytesToReadEIJ=EJFikbytesAvailEJH;iireadsizeEKI=ELBihnetReadELD(ELKigsocketELL,EMB(EMDEP*EMI)&EMK(EMLigbufferEMMpENCigheaderENE),ENLilbytesToReadENN);DB(F@DiireadsizeF@EBMF@N-FAACM)AL(FAMifunifyFAN(FBCidtcbFBD,FBGidtcbFBHpFBKieargsFBM[FCACM],FCDihmakeintFCE(FCL&FCMidtcbFCNpFDAichpFDC,FDEiferrnoFDG)));igbufferFELpFFBiidataSizeFFD=FFMiireadsizeFFO;ikbytesAvailFGNBEFHIiireadsizeFHL;DB(FLIigbufferFLJpFM@iidataSizeFMBBMFMKCG(FNDiiTSHeaderFNE)){DB(GABinGetTSEncodingGAC(GB@igbufferGBA)BNGBIilTS_ENCODINGGBL)AL(GDEifunifyGDF(GDKidtcbGDL,GDOidtcbGE@pGECieargsGEE[GEICM],GELihmakeintGEM(GFD&GFEidtcbGFFpGFIichpGFK,GFM-GG@CM)));DB(GLIilGetTSLengthGLJ(GMEigbufferGMF)>GMNigbufferGN@pGNFikbufferSizeGNH-GOCCM)AL(H@FifunifyH@G(H@LidtcbH@M,HA@idtcbHAApHADieargsHAF[HAJCM],HAMihmakeintHAN(HBE&HBFidtcbHBGpHBJichpHBL,HBN-HC@CM)));}HDL}HDODB(HKHikbytesAvailHKIBMHLDCN)AL(HMEifunifyHMF(HMKidtcbHML,HMOidtcbHN@pHNCieargsHNE[HNICM],HNLihmakeintHNM(HOD&HOEidtcbHOFpHOIichpHOK,HOMijETIMEDOUTHOO)));ilbytesToReadIBA=IBMilGetTSLengthIBO(ICJigbufferICK)-IDCigbufferIDEpIDKiidataSizeIDM;DB(IEKilbytesToReadIEL>IFHikbytesAvailIFJ)ilbytesToReadIGK=IHGikbytesAvailIHI;iireadsizeIIF=IIOihnetReadIJA(IJHigsocketIJI,IJO(IKAc*IKF)&IKH(IKIigbufferIKJpIL@igheaderILB)+ILJigbufferILLpIMBiidataSizeIMD,IMLilbytesToReadIMN);igprintfJ@@(J@Fs,JBM(JBNn)iireadsizeJCD,JCL(JCNn)ilbytesToReadJDD);igprintfJEC(JEIs);AH(JFMibiJFN=JFOCN;ibiJGCBOJGEiireadsizeJGH;CEJHBibiJHD)igprintfJHJ(JI@s,JIEigbufferJIGpJIMiedataJIO[JJCibiJJD]);igprintfJJJ(JK@s);DB(JLGiireadsizeJLHBMJMA-JMDCM)AL(JNCifunifyJND(JNIidtcbJNJ,JNMidtcbJNNpJOAieargsJOC[JOGCM],JOJihmakeintJOK(K@B&K@CidtcbK@DpK@GichpK@I,K@KiferrnoK@M)));igbufferKAHpKANiidataSizeKB@BDKBIiireadsizeKBL;DB(KGGigbufferKGHpKGNiidataSizeKH@BNKHIilGetTSLengthKHL(KIGigbufferKIH))AL(KJLifunifyKJM(KKBidtcbKKC,KKFidtcbKKGpKKJieargsKKL[KL@CM],KLCihmakeintKLD(KLK&KLLidtcbKLMpKM@ichpKMB,KMDijETIMEDOUTKMF)));DB(LLHigbufferLLIpLLOiedataLMA[LMEigbufferLMFpLMLiidataSizeLMN-LNGCG(LNOiiTSHeaderLO@)-LOJCM]BNLOOCN)AL(MA@ifunifyMAA(MAFidtcbMAG,MAJidtcbMAKpMANieargsMB@[MBDCM],MBGihmakeintMBH(MBO&MC@idtcbMCApMCDichpMCF,MCH-MCJCM)));igprintfMIL(MJBs,MMJigbufferMMLpMNBiedataMND);ietermMOD=MOIinBNRP_makeTermMOK(N@H(N@IiiBNRP_TCBN@J*NAB)idtcbNAE,NAHigbufferNAJpNB@iedataNBB);igbufferNBKpNCAiidataSizeNCC=NCLCN;DB(NENietermNEOBMNFDCN)AL(NGEifunifyNGF(NGKidtcbNGL,NGOidtcbNH@pNHCieargsNHE[NHICM],NHLihmakeintNHM(NID&NIEidtcbNIFpNIIichpNIK,NIM-NIOCM)));ALifunifyOAN(OBCidtcbOBD,OBGidtcbOBIpOBLieargsOBN[OCBCM],OCEihmakeintOCG(OCN&OCOidtcbOD@pODCichpODE,ODGCN))BLODMifunifyOE@(OEEidtcbOEF,OEIidtcbOEKpOENieargsOF@[OFDCM],OFGietermOFI);}OGFAL(OJBifunifyOJC(OJHidtcbOJI,OJLidtcbOJMpOK@ieargsOKB[OKFCM],OKIihmakeintOKJ(OLA&OLBidtcbOLCpOLFichpOLH,OLJijETIMEDOUTOLL)));}OMK
BNRP_sendTCPbytes"32781 N {EAigsocket29,2?ihmessage31,38iglength3:;ieFILE45*4<iffilep4=;EIilsockaddr_in5?ildestination6;;ipBNRP_sighandler7;iroldSigPipeHandler8;;c*:8igbuffer:9;EAikbuffersize>?;nijreadbytesACE;nikwritebytesAGK;nijerrorcodeALA;nigoptlenB@G;nifindexBAI=BAOCN;EAibpBBO,BC@ieorigBCB,BCFigresultBCH;idptrBDCieaddrBDK;idTAGBEDidtagBEL;EAijtotalsizeBH@=BHJCN;EAiktotalbytesBIJ=BJDCN;DB(BKFidtcbBKGpBKJihnumargsBKLicNEBLDCM)AL(BM@ifFALSEBMA);DB(BMN!BMOisBNRPnetworkUseableBN@)AL(BOJifFALSEBOK);DB(C@KiicheckArgC@L(CADidtcbCAEpCAHieargsCAJ[CANCM],CBA&CBBigsocketCBC)icNECBKieINTTCBN)AL(CCJifFALSECCK);DB(CDH!CDIiiFD_ISSETCDJ(CEBigsocketCEC,CEI&CEJihBNRPfdsCEK))AL(CIEifunifyCIF(CIKidtcbCIL,CIOidtcbCJ@pCJCieargsCJE[CJICM],CJLihmakeintCJM(CKD&CKEidtcbCKFpCKIichpCKK,CKMiiENOTSOCKCKN)));DB(CM@!CMAiiFD_ISSETCMB(CMJigsocketCMK,CNA&CNBiqBNRPconnectedFdsCNC))AL(DAMifunifyDAN(DBCidtcbDBD,DBGidtcbDBHpDBKieargsDBM[DCACM],DCDihmakeintDCE(DCL&DCMidtcbDCNpDDAichpDDC,DDEiiENOTCONNDDF)));ijerrorcodeDEG=DFACN;iroldSigPipeHandlerDFJ=DGLiwBNRP_installSighandlerDGN(DIDihSIGPIPEDIE,DILitBNRP_initSighandlerDIN(DKAiosigPipeHandlerDKB));DB(DNAiicheckArgDNB(DNJidtcbDNKpDNNieargsDO@[DODCM],DOG&DOHihmessageDOI)icNEE@BifLISTTE@E)AL(EAHifFALSEEAI);DB(EDIiicheckArgEDJ(EEBidtcbEECpEEFieargsEEH[EELCM],EEO&EF@iglengthEFA)icNEEFIieINTTEFL)AL(EGNifFALSEEGO);igprintfEIK(EJAs);DB(FALikgetsockoptFAM(FBGigsocketFBH,FBNikSOL_SOCKETFC@,FCJijSO_SNDBUFFCL,FDE(FDGihoptValTFDH*FE@)&FEBikbuffersizeFEC,FEM(FEOiloptValSizeTFF@*FFL)&FFNigoptlenFFO)icNEFGGCN)ikbuffersizeFHC=FHNimMAX_MSG_SIZEFI@;DB(FMCikbuffersizeFMDicLEFMOCN)ikbuffersizeGBB=GBMimMAX_MSG_SIZEGBO;DB(GDFikbuffersizeGDGicLTGEBiglengthGEE){ikbuffersizeGFH=GGCiglengthGGE;DB(GHEiksetsockoptGHF(GI@igsocketGIA,GIGikSOL_SOCKETGII,GJCijSO_SNDBUFGJE,GJN(GK@ihoptValTGKA*GKH)&GKJikbuffersizeGKK,GLE(GLGiloptValSizeTGLH)igoptlenGME)icNEGMMCN)ALifunifyGNL(GOAidtcbGOB,GOEidtcbGOGpGOJieargsGOL[H@@CM],H@CihmakeintH@E(H@L&H@MidtcbH@NpHAAichpHAC,HAEigENOMEMHAG));}HBDigbufferHDC=HDJ(HDLc*HEB)ilBNRP_mallocHED(HEOikbuffersizeHF@);DB(HGDigbufferHGEicEQHGLCN)ALifunifyHIA(HIFidtcbHIG,HIJidtcbHILpHIOieargsHJA[HJECM],HJHihmakeintHJJ(HKA&HKBidtcbHKCpHKFichpHKH,HKJigENOMEMHKL));ibpHOG=HOIigaddrofHOK(I@AihmessageI@B);ihderefTVI@O(IAF&IAGibpIAH,IAI&IAKieorigIAL,IB@&IBBidtagIBC,IBF&IBHigresultIBI,IBO&ICAieaddrICB);AP(IDA(IDBidtagIDCicNEIDGieENDTIDJ)BLIE@(IECifindexIED<IEJikbuffersizeIEL)){DB(IJGidtagIJHicNEIJLieINTTIJO){ijBNRP_freeIKO(ILHigbufferILI);AL(IMJifFALSEIMK);}INIDB(JBC(JBDigresultJBEicLTJBLCN)BKJCB(JCEigresultJCFicGTJCMCM)){ijBNRP_freeJE@(JEIigbufferJEJ);AL(JFKifFALSEJFL);}JGJigbufferJHI[JHOifindexJI@]=JIG(JIIc)igresultJJ@;ihderefTVJJO(JKF&JKGibpJKH,JKI&JKJieorigJKK,JKO&JL@idtagJLA,JLD&JLEigresultJLF,JLL&JLMieaddrJLN);ifindexJMKCEJN@;}JNGiferrnoJOC=JOJCN;AG{ikwritebytesK@N=KAIifwriteKAK(KB@igsocketKBA,KBGigbufferKBI,KBOiglengthKCA);}KCMAP(KDE(KDFikwritebytesKDGicEQKEB-KEECM)BLKEI(KELiferrnoKEMicEQKFCifEINTRKFF));DB(KGMikwritebytesKGNicEQKHI-KHLCM){igperrorKMB(KMHs);ijerrorcodeKOK=L@EiferrnoL@G;}LAAigprintfLBF(LBLs,LFGikwritebytesLFK,LGEikbuffersizeLGG);iwBNRP_installSighandlerLIC(LJIihSIGPIPELJJ,LKAiroldSigPipeHandlerLKC);ijBNRP_freeLLJ(LMCigbufferLMD);ALifunifyLNG(LNLidtcbLNM,LO@idtcbLOApLODieargsLOF[LOJCM],LOMihmakeintLON(M@E&M@FidtcbM@GpM@JichpM@L,M@NijerrorcodeMA@));}MAM
BNRP_receiveTCPbytes"36334 N {EAigsocket2;;c*3;igbuffer3=;EAikbuffersize4?;EAiglength65;nigoptlen77;EAiireadsize89=93CN;EAigfilefd:2;nijerrorcode;4=;>CN;EAifindex<===6CN;imBNRP_Boolean=>idres>;=>?ieTRUE?1;EAigresultA@A;igsize_tA@LifbytesAAC;idTAGAAMidtagABC;DB(ABOidtcbAC@pACCihnumargsACEicNEACMCM)AL(ADIifFALSEADJ);DB(AEG!AEHisBNRPnetworkUseableAEI)AL(AGCifFALSEAGD);DB(AHAiicheckArgAHB(AHJidtcbAHKpAHNieargsAI@[AIDCM],AIG&AIHigsocketAII)icNEAJAieINTTAJD)AL(AK@ifFALSEAKA);DB(AKNigsocketAKOicLTALFCM)AL(AMBifFALSEAMC);idtagAMN=ANBiicheckArgAND(ANLidtcbANMpAO@ieargsAOB[AOFCM],AOI&AOJiglengthAOK);DB(B@I(B@JidtagB@KicNEB@OieINTTBAB)BLBAH(BAKidtagBALicNEBB@ieVARTBBC))AL(BCFifFALSEBCG);DB(BDH!BDIiiFD_ISSETBDJ(BEBigsocketBEC,BEI&BEJihBNRPfdsBEK))AL(BIIifunifyBIJ(BIOidtcbBJ@,BJCidtcbBJDpBJGieargsBJI[BJMCM],BK@ihmakeintBKA(BKH&BKIidtcbBKJpBKMichpBKO,BLAiiENOTSOCKBLB)));DB(BMF!BMGiiFD_ISSETBMH(BN@igsocketBNA,BNG&BNHiqBNRPconnectedFdsBNI))AL(CBGifunifyCBH(CBMidtcbCBN,CCAidtcbCCBpCCEieargsCCG[CCKCM],CCNihmakeintCCO(CDF&CDGidtcbCDHpCDKichpCDM,CDOiiENOTCONNCE@)));igprintfCGA(CGGs);igoptlenCNN=COECG(COMikbuffersizeCON);DB(DAAikgetsockoptDAB(DALigsocketDAM,DBCikSOL_SOCKETDBE,DBOijSO_RCVBUFDCA,DCJ(DCLihoptValTDCM*DDE)&DDGikbuffersizeDDH,DEB(DEDiloptValSizeTDEE*DFA)&DFCigoptlenDFD)icNEDFLCN)ikbuffersizeDGH=DHCimMAX_MSG_SIZEDHE;DB(DLBikbuffersizeDLCicLEDLNCN)ikbuffersizeE@O=EAJimMAX_MSG_SIZEEAL;DB(EC@(ECAidtagECBicEQECFieINTTECI)BLECO(EDBiglengthEDC<EDJikbuffersizeEDL))ikbuffersizeEEO=EFJiglengthEFL;igprintfEHH(EHNs,EKHikbuffersizeEKJ);igbufferEMA=EMH(EMJc*EN@)ilBNRP_mallocENB(ENMikbuffersizeENN);DB(F@AigbufferF@BicEQF@ICN)ALifunifyFAL(FBAidtcbFBB,FBEidtcbFBGpFBJieargsFBL[FC@CM],FCCihmakeintFCE(FCL&FCMidtcbFCNpFDAichpFDC,FDEigENOMEMFDG));DB(FHIimselectSocketFHJ(FIFigsocketFIG,FIMioBNRPread_timerFIN)){igprintfFLJ(FM@s);AG{iferrnoGAI=GAOCN;iireadsizeGBF=GBOiereadGCA(GCEigsocketGCF,GCLigbufferGCN,GDDikbuffersizeGDF);}GEIAP(GFA(GFBiireadsizeGFCicEQGFL-GFOCM)BLGGC(GGFiferrnoGGGicEQGGMifEINTRGH@));DB(GIBiireadsizeGICicEQGIL-GIOCM){igperrorGNH(GNNs);ijerrorcodeHAB=HALiferrnoHAN;}HBKDB(HCFiireadsizeHCGicEQHD@CN){igprintfHHL(HIBs);ijerrorcodeHLG=HMAiiENOTCONNHMC;}HNC}HNHDC{igprintfI@G(I@Ms);ijerrorcodeIDI=IECijETIMEDOUTIEE;}IHJigprintfIJA(IJGs,ILNiireadsizeIM@);DB(INI!INJijerrorcodeINK){ijheapcheckJCA(JCJiireadsizeJCK+JDCCM);igresultJDN=JEEiimaketermJEG(JEOihLISTTAGJF@,JFGidtcbJFIpJFLichpJFN);AP(JGNiireadsizeJGO>JHHifindexJHJ){iepushJIK(JIOEA,JJDidtcbJJEpJJHichpJJJ,JJLilmakeinttermJJM(JKH(JKIENc)igbufferJLH[JLNifindexJLO]));ifindexJMLCEJNA;}JNKiepushJOC(JOGEA,JOLidtcbJOMpK@@ichpK@B,K@DCN);}KACDC{ijBNRP_freeKBI(KCBigbufferKCC);ALifunifyKDI(KDNidtcbKDO,KEBidtcbKEDpKEGieargsKEI[KEMCM],KF@ihmakeintKFB(KFI&KFJidtcbKFKpKFNichpKG@,KGBijerrorcodeKGD));}KHDDB(KIHidtagKIIicEQKIMieVARTKJ@)idresKJL=KK@ifunifyKKB(KKGidtcbKKH,KKKidtcbKKLpKKOieargsKLA[KLECM],KLHihmakeintKLI(KM@&KMAidtcbKMBpKMEichpKMG,KMIiireadsizeKMJ));ijBNRP_freeKNO(KOHigbufferKOI);ALidresL@MBLLAAifunifyLAD(LAIidtcbLAJ,LAMidtcbLANpLBAieargsLBC[LBGCM],LBJigresultLBK)BLLCCifunifyLCF(LCKidtcbLCL,LCOidtcbLDApLDDieargsLDF[LDJCM],LDMihmakeintLDO(LEF&LEGidtcbLEHpLEKichpLEM,LEOijerrorcodeLFA));}LFN